# 受発注・在庫管理システム 要件定義（MVP v1）

最終更新日: 2026-02-13
対象: フルスタック開発（Backend: Spring Boot / Frontend: React + TypeScript）

## 1. 背景と目的

中小規模の卸売・小売業務では、受注登録と在庫管理がExcel中心になりやすく、在庫引当ミスやステータス連携漏れが発生しやすい。
本システムの目的は、以下を一元化して業務ミスを減らすこと。

- 商品マスタ管理
- 在庫の入庫・引当・確定・取消
- 受注のステータス管理
- ロール別アクセス制御

## 2. プロジェクトスコープ

### 2.1 MVPで実装する範囲（In Scope）

- 認証（ログイン）と認可（`ADMIN` / `OPERATOR` / `VIEWER`）
- 商品CRUD
- 在庫追加（入庫）
- 受注作成（在庫引当）
- 受注確定（引当在庫消込）
- 受注キャンセル（引当解除・在庫戻し）
- 低在庫レポート（定期ジョブ）
- 監視用ヘルスチェック

### 2.2 MVPでは対象外（Out of Scope）

- 決済機能
- 請求書発行
- 外部ECモール連携
- 複数倉庫管理
- 高度な分析ダッシュボード（BI）

## 3. 想定ユーザーと権限

- `ADMIN`
  - 全機能利用可
  - ユーザー管理（MVPでは初期ユーザー固定）
- `OPERATOR`
  - 商品参照、在庫追加、受注作成・確定・キャンセル
- `VIEWER`
  - 商品・在庫・受注の参照のみ

## 4. 業務ルール

- 在庫は `available_quantity`（販売可能）と `reserved_quantity`（引当済）で管理する。
- 受注作成時に必要数量を `available -> reserved` へ移動する。
- 受注確定時に `reserved` を減算し、出荷済み相当として確定する。
- 受注キャンセル時に `reserved -> available` へ戻す。
- `RESERVED` 状態の受注のみ `CONFIRMED` / `CANCELLED` へ遷移可能。

## 5. 機能要件

## 5.1 認証・認可

- FR-001: ユーザーはログインしてAPIへアクセスできること。
- FR-002: 未認証リクエストは拒否すること（ヘルスチェック除く）。
- FR-003: ロールごとに機能アクセスを制御できること。

## 5.2 商品管理

- FR-010: ADMINは商品を作成できること（`sku`一意）。
- FR-011: ADMINは商品情報（名称・説明・単価）を更新できること。
- FR-012: 全ロールは商品一覧・詳細を参照できること。

## 5.3 在庫管理

- FR-020: ADMIN/OPERATORは在庫を追加できること。
- FR-021: すべての商品は在庫情報（販売可能・引当済）を持つこと。
- FR-022: 同時更新でも在庫不整合が起きないこと（トランザクション制御）。

## 5.4 受注管理

- FR-030: ADMIN/OPERATORは受注を作成できること。
- FR-031: 受注作成時、在庫不足なら作成を拒否すること。
- FR-032: 受注確定時、ステータスを `CONFIRMED` に更新すること。
- FR-033: 受注キャンセル時、ステータスを `CANCELLED` に更新し在庫を戻すこと。
- FR-034: 全ロールは受注一覧・詳細を参照できること。

## 5.5 定期ジョブ

- FR-040: 毎日1回、低在庫商品を抽出するジョブを実行できること。
- FR-041: 閾値は環境変数で変更できること。

## 6. 画面要件（フロントエンド）

## 6.1 画面一覧

- SCR-001: ログイン画面
- SCR-002: ダッシュボード（主要件数・低在庫）
- SCR-003: 商品一覧画面
- SCR-004: 商品作成/編集モーダル
- SCR-005: 在庫追加操作画面（商品詳細内またはモーダル）
- SCR-006: 受注一覧画面
- SCR-007: 受注作成画面（明細追加形式）
- SCR-008: 受注詳細画面（確定/キャンセル操作）

## 6.2 画面共通要件

- SCR-C01: ロールに応じて操作ボタンを出し分けること。
- SCR-C02: APIエラーをユーザーが理解できる文言で表示すること。
- SCR-C03: 日付・通貨表示は日本向けフォーマットを使用すること。
- SCR-C04: PC/タブレット想定で崩れないレスポンシブ対応を行うこと。

## 7. API要件（MVP）

現行バックエンドで提供中（または予定）の主要API。

- `GET /api/auth/me`
- `GET /api/products`
- `GET /api/products/{productId}`
- `POST /api/products`（ADMIN）
- `PUT /api/products/{productId}`（ADMIN）
- `POST /api/products/{productId}/stock`（ADMIN/OPERATOR）
- `GET /api/orders`
- `GET /api/orders/{orderId}`
- `POST /api/orders`（ADMIN/OPERATOR）
- `POST /api/orders/{orderId}/confirm`（ADMIN/OPERATOR）
- `POST /api/orders/{orderId}/cancel`（ADMIN/OPERATOR）

## 8. 非機能要件

- NFR-001: API平均応答時間 500ms以内（ローカル検証、通常負荷）。
- NFR-002: 主要更新処理はトランザクションで整合性を保証すること。
- NFR-003: ヘルスチェックエンドポイントを提供すること。
- NFR-004: ログから障害原因を追跡できること（例外、ジョブ実行結果）。
- NFR-005: 設定値（DB接続、ジョブ閾値）は環境変数で切替可能であること。

## 9. データ要件

主要エンティティ:

- `app_users`
- `products`
- `inventories`
- `sales_orders`
- `sales_order_items`

制約:

- `products.sku` は一意
- `sales_orders.order_number` は一意
- `inventories.product_id` は一意（1商品1在庫レコード）

## 10. 受け入れ基準（MVP）

- AC-001: 認証なしで業務APIにアクセスできない。
- AC-002: ADMINで商品作成し、OPERATORで在庫追加できる。
- AC-003: 在庫以上の数量では受注作成が失敗する。
- AC-004: 受注作成で在庫引当が反映される。
- AC-005: 受注確定で引当数量が減算される。
- AC-006: 受注キャンセルで在庫が戻る。
- AC-007: VIEWERは参照のみ可能で更新操作は拒否される。

## 11. 開発マイルストーン

- M1: バックエンドMVP完成（API・DB・認可・ジョブ）
- M2: フロントエンドMVP完成（主要8画面）
- M3: E2Eシナリオ整備（受注作成〜確定/取消）
- M4: デプロイ準備（環境変数整理、運用手順）

## 12. 今後の拡張要件（次フェーズ）

- 端末単位のトークン失効制御とセッション管理
- 監査ログの検索・保持ポリシー（期間、アーカイブ）
- CSV一括登録（商品・在庫）
- 複数倉庫対応
- 売上/在庫回転レポート

## 13. 採用決定（2026-02-13）

- D-001: フロントエンドは `Next.js` を採用する。
- D-002: 認証は `JWT + Refresh Token` を採用する。
- D-003: デプロイ先はMVPでは `Render` を第一候補とする（代替: `Railway`）。
- D-004: 在庫管理はMVPでは単一倉庫で開始する。
