name: CI

on:
  push:
  pull_request:

permissions:
  contents: read

jobs:
  backend:
    name: Backend Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"
          cache: maven

      - name: Run backend tests
        working-directory: backend
        run: ./mvnw -B test

  frontend:
    name: Frontend Lint & Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: pnpm
          cache-dependency-path: frontend/pnpm-lock.yaml

      - name: Install frontend dependencies
        working-directory: frontend
        run: pnpm install --frozen-lockfile

      - name: Run lint
        working-directory: frontend
        run: pnpm lint

      - name: Run build
        working-directory: frontend
        run: pnpm build

  e2e:
    name: End-to-End Test
    runs-on: ubuntu-latest
    needs:
      - backend
      - frontend

    services:
      postgres:
        image: postgres:16
        env:
          POSTGRES_DB: order_mgmt
          POSTGRES_USER: app
          POSTGRES_PASSWORD: app
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U app -d order_mgmt"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "21"
          cache: maven

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: pnpm
          cache-dependency-path: frontend/pnpm-lock.yaml

      - name: Install frontend dependencies
        working-directory: frontend
        run: pnpm install --frozen-lockfile

      - name: Install Playwright browser
        working-directory: frontend
        run: pnpm exec playwright install --with-deps chromium

      - name: Start backend
        working-directory: backend
        env:
          DB_URL: jdbc:postgresql://localhost:5432/order_mgmt
          DB_USERNAME: app
          DB_PASSWORD: app
          CORS_ALLOWED_ORIGINS: http://localhost:3000,http://127.0.0.1:3000
        run: |
          nohup ./mvnw -B -DskipTests spring-boot:run > ../backend.log 2>&1 &

      - name: Wait for backend health
        run: |
          for i in {1..60}; do
            if curl -fsS http://localhost:8080/actuator/health > /dev/null; then
              echo "Backend is healthy"
              break
            fi
            sleep 2
          done

          curl -fsS http://localhost:8080/actuator/health > /dev/null

      - name: Run E2E tests
        working-directory: frontend
        env:
          E2E_BASE_URL: http://localhost:3000
          NEXT_PUBLIC_API_BASE_URL: http://localhost:8080
        run: pnpm test:e2e

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: |
            frontend/playwright-report
            frontend/test-results
          if-no-files-found: ignore

      - name: Upload backend logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: backend-log
          path: backend.log
          if-no-files-found: ignore
